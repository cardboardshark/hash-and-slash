let e=require(`lodash`);var t=class t{static{this.ZeroZero={x:0,y:0}}constructor(e,t){this.x=0,this.y=0,typeof e==`object`&&e?(this.x=e.x,this.y=e.y):t!==void 0&&(this.x=e,this.y=t)}set(e,t){this.x=e,this.y=t}isZeroZero(){return this.x==0&&this.y===0}add(e){return new t({x:this.x+e.x,y:this.y+e.y})}subtract(e){return new t({x:this.x-e.x,y:this.y-e.y})}ceil(){return new t(Math.ceil(this.x),Math.ceil(this.y))}floor(){return new t(Math.floor(this.x),Math.floor(this.y))}round(){return new t(Math.round(this.x),Math.round(this.y))}clone(){return new t(this)}distanceTo(e){return Math.hypot(e.x-this.x,e.y-this.y)}equals(e){return e?this.x===e.x&&this.y===e.y:!1}roughlyEquals(t,n=.5){return t?(0,e.inRange)(t.x,this.x-n,this.x+n)&&(0,e.inRange)(t.y,this.y-n,this.y+n):!1}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y);return new t(this.x/e,this.y/e)}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}reflect(e){let n=this.dot(e);return new t(this.x-2*n*e.x,this.y-2*n*e.y)}rotate(e){return e===90?new t(this.y*-1,this.x):e===180?new t(this.x*-1,this.y*-1):e===270?new t(this.y,this.x*-1):this.clone()}multiply(e){return new t({x:this.x*e.x,y:this.y*e.y})}multiplyScalar(e,n=5){return new t({x:parseFloat((this.x*e).toFixed(n)),y:parseFloat((this.y*e).toFixed(n))})}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}magnitudeSquared(){return this.x*this.x+this.y*this.y}toPrecision(e){return new t({x:parseFloat(this.x.toFixed(e)),y:parseFloat(this.y.toFixed(e))})}project(e,n){let r=new t(e).multiplyScalar(n);return new t(this).add(r)}draw(){return new x([{x:this.x,y:this.y,value:`P`}])}};const n=`⠀`,r=180/Math.PI,i=Math.PI/180,a={UP:`up`,RIGHT:`right`,LEFT:`left`,DOWN:`down`,SPACE:`space`,SHIFT:`shift`,ALT:`alt`,META:`meta`},o=[a.UP,a.RIGHT,a.DOWN,a.LEFT],s={up:{radian:270*i,vector:new t(0,-1),keys:[`up`]},upRight:{radian:315*i,vector:new t(1,-1),keys:[`up`,`right`]},right:{radian:0,vector:new t(1,0),keys:[`right`]},downRight:{radian:135*i,vector:new t(1,1),keys:[`down`,`right`]},down:{radian:90*i,vector:new t(0,1),keys:[`down`]},downLeft:{radian:45*i,vector:new t(-1,1),keys:[`left`,`down`]},left:{radian:180*i,vector:new t(-1,0),keys:[`left`]},upLeft:{radian:225*i,vector:new t(-1,-1),keys:[`left`,`up`]}};function c(e){if(e===void 0)return{x:{value:0,is_percent:!1},y:{value:0,is_percent:!1}};let[t,n]=e.trim().split(` `);if(n===void 0){let e=t.includes(`%`);return{x:{value:e?parseFloat(t)/100:Number(t),is_percent:e},y:{value:e?parseFloat(t)/100:Number(t),is_percent:e}}}else if(t!==void 0&&n!==void 0)return{x:{value:t.includes(`%`)?parseFloat(t)/100:Number(t),is_percent:t.includes(`%`)},y:{value:n.includes(`%`)?parseFloat(n)/100:Number(n),is_percent:n.includes(`%`)}};else throw Error(`invalid position string.`)}function ee(e){return{x:Math.cos(e),y:-Math.sin(e)}}function te(e,t){let n=t.x-e.x,r=t.y-e.y,i=Math.atan2(-r,n);return i<0?i+Math.PI*2:i}function ne(e){return d(e.reduce((e,n)=>(e.push(new t(n.left,n.top)),e.push(new t(n.left+n.width,n.top)),e.push(new t(n.left,n.bottom)),e.push(new t(n.left+n.width,n.top)),e),[]))}function l(e,t){return{top:e.top+t.y,right:e.right+t.x,bottom:e.bottom+t.y,left:e.left+t.x,width:e.width,height:e.height}}function re(e,n,r=``){if(!r||r.trim()===``)return t.ZeroZero;let i=c(r),a=0,o=0;return a=i.x.is_percent?e.width*i.x.value-n.width*i.x.value:i.x.value,o=i.y.is_percent?e.height*i.y.value-n.height*i.y.value:i.y.value,new t(a,o)}function u(e,t){let n=e.x>=t.position.x&&e.x<t.position.x+t.width,r=e.y>=t.position.y&&e.y<t.position.y+t.height;return n&&r}function d(e){let t=e.reduce((e,t)=>(t.x<e.left&&(e.left=t.x),t.x>e.right&&(e.right=t.x),t.y<e.top&&(e.top=t.y),t.y>e.bottom&&(e.bottom=t.y),e),{left:0,right:0,top:0,bottom:0,width:0,height:0});return{...t,width:t.right-t.left,height:t.bottom-t.top}}function ie(e,t,n=2){let r=t*(Math.PI/180),i=Math.cos(r),a=Math.sin(r);return[...e].map(e=>{let t=e.x*i-e.y*a,r=e.x*a+e.y*i;return e.x=parseFloat(t.toFixed(n)),e.y=parseFloat(r.toFixed(n)),e})}function f(e,t,n){return e*(1-n)+n*t}function p(e,t){let n=t.x-e.x,r=t.y-e.y;return Math.max(Math.abs(n),Math.abs(r))}function m(e,t,n){let r=f(e.x,t.x,n),i=f(e.y,t.y,n);return{x:Math.round(r),y:Math.round(i)}}var h=class{constructor(e,n){this.stroke=`l`,this.shaders=[],this.visible=!0,this.start=new t(e),this.end=new t(n)}get length(){return this.start.distanceTo(this.end)}get radian(){return te(this.start,this.end)}toPoints(){let e=[],t=p(this.start,this.end);for(let n=0;n<=t;n++){let r=t===0?0:n/t;e.push(m(this.start,this.end,r))}return e}rotate(e){let n=e%(Math.PI*2),r=this.length,i=this.radian+n;this.end=this.start.add(new t({x:Math.cos(i),y:Math.sin(i)}).multiplyScalar(r)).round()}setLength(e){return this.end=this.start.project(ee(this.radian),e),this}getNormal(){let e=this.end.x-this.start.x,n=-(this.end.y-this.start.y),r=e,i=Math.sqrt(n*n+r*r);return i===0?new t(0,0):new t(n/i,r/i)}draw(){let e=[],t=p(this.start,this.end);for(let n=0;n<=t;n++){let r=t===0?0:n/t,{x:i,y:a}=m(this.start,this.end,r);e.push({x:i,y:a,value:String(this.stroke).substring(0,1)})}return new x(e)}get boundingBox(){return d([this.start,this.end])}};let g=-1;var _=class e{constructor(){this.x=0,this.y=0,this.children=new Set,this.visible=!0,this.hasBoundingBoxChanged=!1,this.nodeId=g,this.id=`Node2d-${this.nodeId}`,g+=1}set(e){return typeof e==`function`?this.pointReferenceFn=e:(this.x=e.x,this.y=e.y),this.hasBoundingBoxChanged=!0,this}get position(){return this.pointReferenceFn?new t(this.pointReferenceFn()):new t(Math.floor(this.x),Math.floor(this.y))}get precisePosition(){return this.pointReferenceFn?new t(this.pointReferenceFn()):new t(this.x,this.y)}get originPosition(){if(this.origin===void 0||this.memoizedBoundingBox===void 0)return this.position;let e=this.memoizedBoundingBox,n=c(this.origin),r=0,i=0;return r=n.x.is_percent?f(0,(e.width-1)*-1,n.x.value):n.x.value,i=n.y.is_percent?f(0,(e.height-1)*-1,n.y.value):n.y.value,this.position.add(new t(r,i))}setOrigin(e){return this.origin=e,this.hasBoundingBoxChanged=!0,this}appendChild(e){return this.children.has(e)===!1&&this.children.add(e),this.hasBoundingBoxChanged=!0,this}removeChild(e){return this.children.delete(e),this.hasBoundingBoxChanged=!0,this}setChildren(e){return this.children=new Set(e),this.hasBoundingBoxChanged=!0,this}get boundingBox(){return(this.memoizedBoundingBox===void 0||this.hasBoundingBoxChanged===!0)&&this.children.size>0&&(this.memoizedBoundingBox=l(ne(Array.from(this.children.values()).map(e=>e.boundingBox)),this.originPosition),this.hasBoundingBoxChanged=!1),this.memoizedBoundingBox??{left:0,top:0,right:0,bottom:0,width:0,height:0}}draw(){let t=new x;return Array.from(this.children.values()).filter(e=>e.visible).forEach(n=>n instanceof e?t.merge(n.draw(),{offset:n.originPosition}):t.merge(n.draw())),t}},v=class extends _{constructor(...e){super(...e),this.shaders=[],this._debug=!1}},y=class e extends v{constructor(e,n,r){super(),this.fill=`⠀`,this.set(new t(e.x,e.y)),this.text=n,this.options=r}draw(){let e=String(this.text).split(`
`),t=e.reduce((e,t)=>(t.length>e&&(e=t.length),e),0),{width:n,align:r=`left`,fill:i=`⠀`}=this.options??{},a=n??t,o=e.map(e=>{let t=e;if(e.length<a)if(r===`left`)t=e.padEnd(a,i);else if(r===`center`){let n=Math.floor((a-e.length)/2);t=[new String().padStart(n,i),e,new String().padEnd(n,i)].join(``),t.length!==a&&(t=t.padEnd(a,i))}else t=e.padStart(a,i);return t});return x.parse(o.join(`
`))}get boundingBox(){let e=String(this.text).split(`
`),t=e.reduce((e,t)=>(t.length>e&&(e=t.length),e),0),{width:n,align:r=`left`}=this.options??{},i=n??t,a=this.position.x;return n===void 0&&r!==void 0&&(r===`right`?a-=i:r===`center`&&(a-=Math.floor(i/2))),{left:a,right:a+i,top:this.position.y,bottom:this.position.y+e.length,width:i,height:e.length}}static fromPoints(t,n,r=`X`){let i=d(n),a=``;for(let e=i.top;e<i.bottom;e+=1){let e=Array.from({length:i.width});for(let t=i.left;t<i.right;t+=1)e.splice(t,1,r);a+=`${e.join(``)}\n`}return new e(t,a)}},ae=class{constructor(){}},oe=class e extends ae{constructor({src:e,position:t,fill:n}){super(),this.fill=n==null?null:String(n).substring(0,1),this.src=e,this.position=t}apply(e){if(this.fill&&e.fillRectangle(new b(new t(e.boundingBox.left,e.boundingBox.top),e.boundingBox.width+1,e.boundingBox.height+1),this.fill),this.src!==void 0){let n=new y(t.ZeroZero,this.src).draw(),r=re(e.boundingBox,n.boundingBox,this.position);e.merge(n,{offset:r,lockTransparentPixels:!0})}return e}static apply(t,n){return n instanceof e&&n.apply(t),typeof n==`object`&&new e(n).apply(t),(typeof n==`string`||typeof n==`number`)&&new e({src:n}).apply(t),t}},b=class e extends v{constructor(e,t,n){super(),this.set(e),this.width=t,this.height=n}get lines(){return[new h(this.position,this.position.add({x:this.width,y:0})),new h(this.position.add({x:this.width,y:0}),this.position.add({x:this.width,y:this.height})),new h(this.position.add({x:0,y:this.height}),this.position.add({x:this.width,y:this.height})),new h(this.position,this.position.add({x:0,y:this.height}))]}draw(){let n=new x().fillRectangle(new e(t.ZeroZero,this.width,this.height));return n=oe.apply(n,this.background),this.rotate&&n.rotate(this.rotate),n}get boundingBox(){return{left:this.position.x,right:this.position.x+this.width,bottom:this.position.y+this.height,top:this.position.y,width:this.width,height:this.height}}},x=class t{#e;constructor(e=[]){this.pixelMap=new Map,this.hasChanged=!0,e.forEach(e=>this.pixelMap.set(this.#t(e),e))}#t(e){return`${e.x},${e.y}`}fillRectangle(e,t=null){for(let n=e.position.y;n<e.height;n+=1)for(let r=e.position.x;r<e.width;r+=1){let e={x:r,y:n,value:t};this.pixelMap.set(this.#t(e),e)}return this}deleteRectangle(e){return this.fillRectangle(e,null)}toString({crop:t,fill:n=` `}={}){let r=Array.from(this.pixelMap.values());if(t){let e=new b(t.position,t.width,t.height);r=r.filter(t=>u(t,e))}let i=(0,e.sortBy)(r,[`y`,`x`]),a;return i.reduce((e,t)=>(a===void 0&&(a=t.y),t.y!==a&&(e+=`
`,a=t.y),t.value===null?e+=n:e+=t.value,e),``)}merge(e,t={}){return e.pixelMap.forEach(e=>{if(e.value!==`⠀`&&e.value!==null){let n=t.offset?{x:Math.round(e.x+t.offset.x),y:Math.round(e.y+t.offset.y)}:e;(t.limit===void 0||u(n,t.limit))&&(this.pixelMap.has(this.#t(n))||t.lockTransparentPixels!==!0)&&this.pixelMap.set(this.#t(n),{x:n.x,y:n.y,value:e.value})}}),this.hasChanged=!0,this}get boundingBox(){return(this.hasChanged||this.#e===void 0)&&(this.#e=d(Array.from(this.pixelMap.values()))),this.#e}rotate(e){return new t(ie(Array.from(this.pixelMap.values()),e))}static intersect(e,t){let n=Array.from(e.buffer.pixelMap.values()).reduce((t,n)=>{let r=e.offset?{x:Math.round(n.x+e.offset.x),y:Math.round(n.y+e.offset.y),value:n.value}:n;return t[e.buffer.#t(r)]={source:n,offset:r},t},{}),r=Array.from(t.buffer.pixelMap.values()).reduce((e,n)=>{let r=t.offset?{x:Math.round(n.x+t.offset.x),y:Math.round(n.y+t.offset.y),value:n.value}:n;return e[t.buffer.#t(r)]={source:n,offset:r},e},{});return Object.entries(n).reduce((e,[t,n])=>(r[t]!==void 0&&r[t].source.value!==null&&r[t].source.value!==`⠀`&&e.push(n),e),[])}static parse(e){return new t(e.split(`
`).reduce((e,t,n)=>{let r=Array.from(t).map((e,t)=>({x:t,y:n,value:e}));return e.concat(r)},[]))}},se=class{constructor(e,t){this.width=e,this.height=t}get offset(){return{x:Math.ceil(this.width/10),y:Math.ceil(this.height/10)}}draw(){let e=this.offset.x,n=this.offset.y,r=this.height+n*2,i=Array.from({length:r}).fill(null).map(()=>[]);for(let e=0;e<this.width;e+=1){let t=Math.floor(e/10)===0?` `:Math.floor(e/10),n=e%10;i.at(0)?.push(t),i.at(1)?.push(n),i.at(2)?.push(`↓`),i.at(-3)?.push(`↑`),i.at(-1)?.push(n),i.at(-2)?.push(t)}let a=i.map((t,i)=>{let a=t.join(``).padEnd(this.width),o=`${new String().padStart(e-1,` `)} `,s=` ${new String().padStart(e-1,` `)}`;return i>=n&&i<r-n&&(o=`${String(i-n).padStart(e-1,` `)}→`,s=`←${String(i-n).padEnd(e-1,` `)}`),`${o}${a}${s}`}).join(`
`);return new y(t.ZeroZero,a).draw()}},S=class{constructor(e){this.debugMode=!1,this.element=null,this.width=0,this.height=0,this.width=e.width,this.height=e.height,this.element=e.element,this.debugMode=e.debugMode??!1}draw(e){let n=new b(t.ZeroZero,this.width,this.height),r=new x;if(r.fillRectangle(n),this.debugMode){let e=new se(this.width,this.height);r.merge(e.draw(),{offset:new t(0,0).subtract(e.offset)})}if(r.merge(e.draw(),{limit:n}),!this.element)throw console.log(this.element),Error(`Unable to locate canvas element.`);this.element.style.setProperty(`--width`,String(this.width)),this.element.style.setProperty(`--height`,String(this.height));let i=r.toString();this.element.innerHTML!==i&&(this.element.innerHTML=i)}};const C=new S({width:20,height:10,element:document.querySelector(`.debug`)});function ce(e){return()=>{let n=new _;Object.entries(e.keys).forEach(([e,r],i)=>{if(r.pressed&&(r.doubleTap?n.appendChild(new y(new t(0,i),`██`)):n.appendChild(new y(new t(0,i),`█`)),r.timestamp)){let e=new y(new t(C.width-1,i),`${Date.now()-r.timestamp}ms`).setOrigin(`100% 0`);e._debug=!0,n.appendChild(e)}n.appendChild(new y(new t(3,i),e.toUpperCase()))}),C.draw(n)}}var w=class{#e=new Map;#t=new Map;on(e,t){this.#e.has(e)||this.#e.set(e,new Set),this.#e.get(e)?.add(t)}off(e,t){if(this.#e.has(e)){if(t===void 0){this.#e.delete(e),this.#t.delete(e);return}this.#e.get(e)?.delete(t)}}emit(t,n,r){Array.from(this.#e.get(t)?.values()??[]).forEach(i=>{if(r)return this.#t.has(t)===!1&&this.#t.set(t,(0,e.debounce)((e,t)=>e(t),r)),this.#t.get(t)?.(i,n);i(n)})}};const T={Space:a.SPACE,ShiftLeft:a.SHIFT,ShiftRight:a.SHIFT,MetaLeft:a.META,MetaRight:a.META,AltLeft:a.ALT,AltRight:a.ALT,KeyW:a.UP,ArrowUp:a.UP,KeyA:a.LEFT,ArrowLeft:a.LEFT,KeyS:a.DOWN,ArrowDown:a.DOWN,KeyD:a.RIGHT,ArrowRight:a.RIGHT},le=300,ue=Object.values(a);var de=class{constructor(e=ue){this.events=new w,this.keys=e.reduce((e,t)=>(e[t]={pressed:!1,doubleTap:!1,timestamp:void 0},e),{}),window.addEventListener(`keydown`,this.#e.bind(this)),window.addEventListener(`keyup`,this.#t.bind(this)),window.addEventListener(`blur`,this.reset.bind(this))}get vector(){let e=Object.entries(this.keys).filter(([,e])=>e.pressed).length,{vector:n}=Object.values(s).find(t=>t.keys.length===e&&t.keys.every(e=>this.keys[e].pressed))??{};return new t(n??t.ZeroZero)}get cardinalVector(){let{vector:e}=Object.values(s).find(e=>e.keys.length===1&&e.keys.every(e=>this.keys[e].pressed))??{};return new t(e??t.ZeroZero)}isDeadStick(){return this.vector.equals(t.ZeroZero)}#e(e){if(Object.hasOwn(T,e.code)===!1)return;let t=T[e.code],n=Date.now();this.keys[t].doubleTap=this.keys[t].doubleTap,this.keys[t].timestamp&&n-this.keys[t].timestamp<300&&(this.keys[t].doubleTap=!0),this.keys[t].timestamp===void 0&&(this.keys[t].timestamp=n),this.keys[t].pressed===!1&&(this.keys[t].pressed=!0,this.events.emit(`keydown`,{keys:this.keys,vector:this.vector},5))}#t(e){if(Object.hasOwn(T,e.code)===!1)return;let t=T[e.code],n=Date.now();this.keys[t].pressed=!1,this.keys[t].doubleTap?this.keys[t].doubleTap=!1:this.keys[t].timestamp=n,this.events.emit(`keyup`,{keys:this.keys})}reset(){Object.keys(this.keys).forEach(e=>{this.keys[e].pressed=!1})}},E=class extends _{constructor(e,t){if(super(),this.index=0,this.width=0,this.height=0,this.numFrames=0,this.frames=[],typeof t==`object`){let{content:e,initialIndex:n=0,width:r,height:i,numFrames:a}=t??{};this.index=n,this.width=r,this.height=i,this.numFrames=a,this.frames=this.#e(e)}else{let e=t.split(`
`);this.width=e.reduce((e,t)=>(t.length>e&&(e=t.length),e),0),this.height=e.length,this.frames=this.#e(t)}this.set(e),this.rect=new b(e,this.width,this.height)}#e(t){return(0,e.chunk)(t.split(`
`),this.height).reduce((t,n)=>{let r=n.reduce((t,n)=>((0,e.chunk)(Array.from(n),this.width+1).forEach((e,n)=>{t[n]??=``,t[n]+=`${e.join(``)}\n`}),t),[]);return t.push(...r),t},[])}previous(e=1){this.next(e*-1)}next(e=1){this.index+=e,this.index>this.numFrames&&(this.index=0)}setFrame(e){this.index=e%this.numFrames}get boundingBox(){return this.rect.boundingBox}draw(){let e=Math.floor(this.index)%this.numFrames;return this.rect.background={src:this.frames.at(e)??`error`},this.rect.rotate=this.rotate,this.rect.draw()}},D=class extends _{constructor(...e){super(...e),this.contacts=new Set}#e=new w;_bodyEntered(e,t){this.#e.emit(`bodyEntered`,{target:this,other:e,intersections:t}),this.bodyEntered(e,t)}bodyEntered(e,t){}_bodyExited(e){this.#e.emit(`bodyExited`,{target:this,other:e}),this.bodyExited(e)}bodyExited(e){}_bodyContact(e,t){this.#e.emit(`bodyContact`,{target:this,other:e,intersections:t}),this.bodyContact(e,t)}bodyContact(e,t){}on(e,t){this.#e.on(e,t)}off(e,t){this.#e.off(e,t)}};let O=-1;var k=class extends D{constructor(){super(),this.constantForce=new t(t.ZeroZero),this.linearVelocity=new t(t.ZeroZero),this.linearDamp=0,this.inertia=0,this.contacts=new Set,this.rid=O+1,O+=1}setConstantForce(e){this.constantForce=e}};function fe(e,t,n=0){let r={x:e.boundingBox.left-n,y:e.boundingBox.top-n,width:e.boundingBox.width+n*2,height:e.boundingBox.height+n*2},i={x:t.boundingBox.left-n,y:t.boundingBox.top-n,width:t.boundingBox.width+n*2,height:t.boundingBox.height+n*2};return r.x<i.x+i.width&&r.x+r.width>i.x&&r.y<i.y+i.height&&r.y+r.height>i.y}const pe=1;var me=class extends _{constructor(...e){super(...e),this.id=`scene`,this.constantForce=new t(t.ZeroZero)}#e=new Set;appendChild(e){return e instanceof D&&this.#e.add(e),super.appendChild(e)}removeChild(e){return e instanceof D&&this.#e.delete(e),super.removeChild(e)}process(e){let n=Array.from(this.#e);n.filter(e=>e instanceof k).forEach(r=>{let i=r.precisePosition.clone(),a=r.precisePosition.clone();if(r instanceof k){if(a=a.add(new t(this.constantForce).multiplyScalar(e.deltaMS)),a=a.add(new t(r.constantForce).multiplyScalar(e.deltaMS)),a=a.add(new t(r.linearVelocity).multiplyScalar(e.deltaMS)),new t(r.linearVelocity).roughlyEquals(t.ZeroZero))r.linearVelocity=new t(t.ZeroZero);else if(r.linearDamp>0){let n=new t(r.linearVelocity).magnitude()-r.linearDamp*e.deltaMS;r.linearVelocity=new t(r.linearVelocity).normalize().multiplyScalar(n)}}if(i.equals(a)===!1){r.set(a);let e=n.filter(e=>e!==r&&fe(r,e,1)).reduce((e,t)=>{let n=x.intersect({buffer:r.draw(),offset:r.originPosition},{buffer:t.draw(),offset:t.originPosition});return n.length>0&&e.push({other:t,intersections:n}),e},[]);e.forEach(({other:e,intersections:t})=>{r.contacts.has(e)===!1&&(r.contacts.add(e),r._bodyEntered(e,t))}),Array.from(r.contacts).filter(t=>e.find(e=>e.other===t)===void 0).forEach(e=>{let t=x.intersect({buffer:r.draw(),offset:r.originPosition},{buffer:e.draw(),offset:e.originPosition});t.length>0?r._bodyContact(e,t):(r.contacts.delete(e),r._bodyExited(e))})}})}},he=class e{static{this.targetFPMS=.06}#e=[];#t=100;#n=null;#r=0;#i;#a=-1;constructor(){this.deltaTime=1,this.speed=.005,this.lastTime=-1,this.started=!1,this.paused=!1,this.windowBlurred=!1,this.deltaMS=1/e.targetFPMS,this.elapsedMS=1/e.targetFPMS,this.#i=e=>{this.#n=null,this.started&&(this.update(e),this.started&&this.#n===null&&this.#e.length>0&&(this.#n=requestAnimationFrame(this.#i)))},window.addEventListener(`blur`,()=>{this.windowBlurred=!0}),window.addEventListener(`focus`,()=>{this.windowBlurred=!1}),document.addEventListener(`keydown`,e=>{e.code===`Escape`&&(this.paused=!this.paused)})}update(t=performance.now()){if(this.paused||this.windowBlurred)return;let n;if(t>this.lastTime){if(n=this.elapsedMS=t-this.lastTime,n>this.#t&&(n=this.#t),n*=this.speed,this.#r){let e=t-this.#a|0;if(e<this.#r)return;this.#a=t-e%this.#r}this.deltaMS=n,this.deltaTime=this.deltaMS*e.targetFPMS,this.#e.forEach(e=>e({deltaMS:this.deltaMS,deltaTime:this.deltaTime,elapsedMS:this.elapsedMS,lastTime:this.lastTime,speed:this.speed}))}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=t}add(e){this.started=!0,this.#e.push(e),this.#n===null&&(this.lastTime=performance.now(),this.#a=this.lastTime,this.#n=requestAnimationFrame(this.#i))}get FPS(){return 1e3/this.elapsedMS}};const A={load(e){let t={}.glob(`@/assets/**/*.txt`,{eager:!0,query:`?raw`,import:`default`}),n=Object.keys(t).find(t=>t.endsWith(`${e}.txt`));if(n&&t[n]!==void 0)return t[n].replaceAll(` `,`⠀`);throw Error(`Unable to load asset ${e}`)}};let j=-1;var M=class extends D{constructor(){super(),this.sid=j+1,j+=1}},N=class extends M{constructor(){super(),this.appendChild(new E(t.ZeroZero,A.load(`apple`)))}placeNewApple(n){let r=[];for(let e=n.boundingBox.top+1;e<n.boundingBox.bottom-3;e+=1)for(let t=n.boundingBox.left+1;t<n.boundingBox.right-3;t+=1)r.push({x:t,y:e});let i=r[(0,e.random)(0,r.length-1)];return i&&(this.set(new t(i)),console.log(`Moving apple to`,this.position)),this}},P=class extends k{constructor(){super(),this.inertia=2;let e=new b(t.ZeroZero,2,2);e.background=`▟▙
▜▛`,this.appendChild(e)}},ge=class extends _{constructor(e,t,n){super(),this.fill=`⠀`,this.set(e),this.width=t,this.height=n}get rectangle(){return new b(this.position,this.width,this.height)}draw(){let e={left:this.position.x,top:this.position.y,bottom:this.position.y+this.height,right:this.position.x+this.width},t=``;for(let n=0;n<this.height;n++){for(let r=0;r<this.width;r++)e.left===r?e.top===n?t+=`╔`:e.bottom===n+1?t+=`╚`:t+=`║`:e.right===r+1?e.top===n?t+=`╗`:e.bottom===n+1?t+=`╝`:t+=`║`:e.top===n||e.bottom===n+1?t+=`═`:t+=this.fill;t+=`
`}let n=new b(this.position,this.width,this.height);return n.background={src:t,fill:`⠀`},n.draw()}},_e=class extends _{constructor(e,t){super(),this.index=0,this.width=0,this.height=0,this.numFrames=4,this.frames={[a.UP]:``,[a.RIGHT]:``,[a.DOWN]:``,[a.LEFT]:``};let{content:n,initialIndex:r=0,width:i,height:o}=t??{};this.index=r,this.width=i,this.height=o,this.frames=this.#e(n),this.set(e),this.rect=new b(e,this.width,this.height)}#e(t){return(0,e.chunk)(t.split(`
`),this.height).reduce((t,n,r)=>{let i=n.reduce((t,n)=>((0,e.chunk)(Array.from(n),this.width+1).forEach((e,n)=>{t[n]??=``,t[n]+=`${e.join(``)}\n`}),t),[]);return t[o[r]]=i.at(0)??``,t},this.frames)}setFrame(e){return this.index=o.findIndex(t=>t===e),this}get boundingBox(){return this.rect.boundingBox}draw(){let e=o.at(this.index)??`up`;return this.rect.background={src:this.frames[e]},this.rect.draw()}},ve=class extends k{static{this.InitialMaxTrailLength=5}constructor({initialPosition:e}){super(),this.allowReversing=!1,this.speed=1,this.fill=`█`,this.damage=[],this.set(e),this.sprite=new _e(t.ZeroZero,{content:A.load(`rocket`),width:3,height:3,numFrames:4})}process(){let e=new t(this.constantForce).normalize();e.equals(s.left.vector)?(this.setOrigin(`0 50%`),this.sprite.setFrame(`left`)):e.equals(s.right.vector)?(this.sprite.setFrame(`right`),this.setOrigin(`100% 50%`)):e.equals(s.down.vector)?(this.sprite.setFrame(`down`),this.setOrigin(`50% 100%`)):e.equals(s.up.vector)&&(this.setOrigin(`50% 0`),this.sprite.setFrame(`up`))}get boundingBox(){return new b(this.originPosition,3,3).boundingBox}draw(){return this.sprite.draw()}},F=class extends M{constructor(e){super(),this.rect=e,this.rect.background=A.load(`wall`),this.set(e.position)}draw(){return this.rect.draw()}get boundingBox(){return this.rect.boundingBox}};const I=new he,L=new de,R=new me,z=new S({width:30,height:30,element:document.querySelector(`.canvas`)});z.debugMode=!0;let B=0,V=!0;const H=new ve({initialPosition:new t(3,3)}),U=new b(new t(1,1),z.width-1,z.height-6);R.appendChild(new F(new b(new t(0,0),z.width,1))),R.appendChild(new F(new b(new t(0,0),1,z.height-6))),R.appendChild(new F(new b(new t(z.width-1,0),1,z.height-6))),R.appendChild(new F(new b(new t(0,z.height-6),z.width,1)));const W=new N;W.placeNewApple(U),R.appendChild(W);const G=new b(t.ZeroZero,z.width,5);G.background={fill:`█`};const K=new y(new t(G.position).add({x:1,y:1}),`\nMy score is: ${B}\n`,{width:z.width-2,align:`center`,fill:` `}),q=new _().setChildren([G,K]);q.set({x:0,y:z.height-5}),R.appendChild(q);const J=new E(new t(z.width-2,z.height-6),A.load(`tree`));J.origin=`100% 100%`,R.appendChild(J),R.appendChild(H);const Y=new P;Y.set(new t(20,10)),Y.constantForce=s.down.vector,Y.on(`bodyEntered`,({other:e})=>{e instanceof F&&Y.constantForce&&(Y.constantForce=Y.constantForce.rotate(180))}),R.appendChild(Y);const X=new E(new t(2,3),{content:A.load(`skull`),width:10,height:6,numFrames:10});X.id=`sprite`;const Z=new ge(new t(0,0),12,9);Z.fill=` `,Z.id=`skullbox`;const Q=new _().setChildren([Z,new y(new t(2,1),`u = dead`),X]);Q.set(new t(9,8)),Q.id=`skucontainer`,Q.visible=!1,R.appendChild(Q),H.on(`bodyEntered`,({other:e})=>{e instanceof N?(B+=1,H.speed+=.5):(e instanceof F||e instanceof P)&&(V=!1)}),H.on(`bodyExited`,({other:e})=>{e instanceof N&&W.placeNewApple(U)}),I.add(e=>{L.isDeadStick()===!1&&(H.constantForce=L.cardinalVector.multiplyScalar(H.speed)),H.process(),R.process(e),K.text=`\nMy score is: ${B}\n`,V===!1&&(X.next(10*e.deltaTime),Q.visible=!0,I.paused=!0),z.draw(R)}),I.add(ce(L));const $=document.querySelector(`.fps`);$&&($.textContent=`FPS: ${I.FPS}`),console.log(`-- Starting! --`);